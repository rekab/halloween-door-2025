<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjustable Door Video Projection with Sound</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: white;
            overflow: hidden;
        }
        .viewport-container {
            position: absolute;
            overflow: hidden;
            min-width: 100px;
            min-height: 100px;
            cursor: move;
        }
        #videoContainer {
            display: block;
        }
        #scareContainer {
            display: none;
        }
        .resize-handle {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 20px;
            height: 20px;
            background: #666;
            cursor: se-resize;
            display: none;
            z-index: 100;
        }
        #scareResizeHandle {
            background: #ff0000;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotate(90deg);
            transform-origin: center;
            pointer-events: none;
            user-select: none;
        }
        #scareImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotate(90deg);
            transform-origin: center;
            pointer-events: none;
            user-select: none;
            -webkit-user-drag: none;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
            transition: opacity 0.3s ease;
        }
        #audioControls {
            margin-top: 10px;
        }
        #controlToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .control-toggle-label {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-toggle-label input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <label class="control-toggle-label" id="controlToggle">
        <input type="checkbox" id="showControls" checked> Show Controls
    </label>

    <!-- Video Container -->
    <div id="videoContainer" class="viewport-container">
        <video autoplay loop muted playsinline draggable="false">
            <source src="creepyhands2.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="resize-handle" id="videoResizeHandle"></div>
    </div>

    <!-- Scare Image Container (independent viewport) -->
    <div id="scareContainer" class="viewport-container">
        <img id="scareImage" src="test_scare.png" alt="Scare Image" draggable="false">
        <div class="resize-handle" id="scareResizeHandle"></div>
    </div>

    <div id="controls">
        <div>
            <button onclick="toggleVideoBorder()">Toggle Video Border</button>
            <button onclick="resetVideoPosition()">Reset Video</button>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="toggleScareBorder()">Toggle Scare Border</button>
            <button onclick="resetScarePosition()">Reset Scare</button>
        </div>
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="debugMode" onchange="toggleDebugMode()">
                Debug Mode (Show Test Scare)
            </label>
        </div>
        <div id="audioControls">
            <button onclick="toggleSound()">Toggle Sound</button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()">
        </div>
    </div>

    <audio id="soundTrack" loop>
        <source src="warcry.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <script>
        // =====================================================================
        // ELEMENT REFERENCES
        // =====================================================================
        const videoContainer = document.getElementById('videoContainer');
        const scareContainer = document.getElementById('scareContainer');
        const videoResizeHandle = document.getElementById('videoResizeHandle');
        const scareResizeHandle = document.getElementById('scareResizeHandle');
        const audio = document.getElementById('soundTrack');
        const volumeSlider = document.getElementById('volumeSlider');
        const controls = document.getElementById('controls');
        const showControlsCheckbox = document.getElementById('showControls');
        const controlToggle = document.getElementById('controlToggle');
        const debugModeCheckbox = document.getElementById('debugMode');
        const video = document.querySelector('video');
        const scareImage = document.getElementById('scareImage');

        // =====================================================================
        // DRAG/RESIZE STATE
        // =====================================================================
        let dragState = {
            active: false,
            container: null,
            startX: 0,
            startY: 0
        };

        let resizeState = {
            active: false,
            container: null,
            startX: 0,
            startY: 0,
            startWidth: 0,
            startHeight: 0,
            aspectRatio: 1
        };

        // Border visibility
        let videoBorderVisible = false;
        let scareBorderVisible = false;

        // Sound state
        let soundPlaying = false;

        // Set initial volume
        audio.volume = volumeSlider.value;

        // =====================================================================
        // CONTROL VISIBILITY
        // =====================================================================
        showControlsCheckbox.addEventListener('change', function() {
            controls.style.opacity = this.checked ? '1' : '0';
            controls.style.pointerEvents = this.checked ? 'auto' : 'none';
        });

        // =====================================================================
        // DRAG AND RESIZE HANDLERS
        // =====================================================================
        function setupDragResize(container, resizeHandle) {
            container.addEventListener('mousedown', (e) => {
                if (e.target === resizeHandle) {
                    // Start resizing
                    resizeState.active = true;
                    resizeState.container = container;
                    resizeState.startX = e.clientX;
                    resizeState.startY = e.clientY;
                    resizeState.startWidth = parseInt(document.defaultView.getComputedStyle(container).width, 10);
                    resizeState.startHeight = parseInt(document.defaultView.getComputedStyle(container).height, 10);
                    resizeState.aspectRatio = resizeState.startWidth / resizeState.startHeight;
                    e.preventDefault();
                } else if (e.target === container) {
                    // Start dragging (only if clicking the container itself, not children)
                    dragState.active = true;
                    dragState.container = container;
                    dragState.startX = e.clientX - container.offsetLeft;
                    dragState.startY = e.clientY - container.offsetTop;
                    e.preventDefault();
                }
            });
        }

        document.addEventListener('mousemove', (e) => {
            if (dragState.active) {
                const container = dragState.container;
                const left = e.clientX - dragState.startX;
                const top = e.clientY - dragState.startY;
                container.style.left = left + 'px';
                container.style.top = top + 'px';

                // Save position if it's scare container
                if (container === scareContainer) {
                    saveScarePosition();
                }
            } else if (resizeState.active) {
                const container = resizeState.container;

                // Calculate change in position
                const deltaX = e.clientX - resizeState.startX;
                const deltaY = e.clientY - resizeState.startY;

                // Use the average of X and Y deltas for diagonal resizing
                // This makes it intuitive: drag down-right to grow, up-left to shrink
                const averageDelta = (deltaX + deltaY) / 2;

                // Calculate new width, maintaining aspect ratio
                const newWidth = resizeState.startWidth + averageDelta;
                const newHeight = newWidth / resizeState.aspectRatio;

                // Ensure minimum size
                const finalWidth = Math.max(100, newWidth);
                const finalHeight = Math.max(100, newHeight);

                container.style.width = finalWidth + 'px';
                container.style.height = finalHeight + 'px';

                // Save size if it's scare container
                if (container === scareContainer) {
                    saveScarePosition();
                }
            }
        });

        document.addEventListener('mouseup', () => {
            dragState.active = false;
            dragState.container = null;
            resizeState.active = false;
            resizeState.container = null;
        });

        // Setup both containers
        setupDragResize(videoContainer, videoResizeHandle);
        setupDragResize(scareContainer, scareResizeHandle);

        // =====================================================================
        // BORDER CONTROLS
        // =====================================================================
        function toggleVideoBorder() {
            videoBorderVisible = !videoBorderVisible;
            videoContainer.style.border = videoBorderVisible ? '2px solid #666' : 'none';
            videoResizeHandle.style.display = videoBorderVisible ? 'block' : 'none';
        }

        function toggleScareBorder() {
            scareBorderVisible = !scareBorderVisible;
            scareContainer.style.border = scareBorderVisible ? '2px solid red' : 'none';
            scareResizeHandle.style.display = scareBorderVisible ? 'block' : 'none';
        }

        // =====================================================================
        // POSITION RESET
        // =====================================================================
        function resetVideoPosition() {
            videoContainer.style.left = '0px';
            videoContainer.style.top = '0px';
            videoContainer.style.width = '50%';
            videoContainer.style.height = '50%';
        }

        function resetScarePosition() {
            scareContainer.style.left = '0px';
            scareContainer.style.top = '0px';
            scareContainer.style.width = '50%';
            scareContainer.style.height = '50%';
            saveScarePosition();
        }

        // =====================================================================
        // AUDIO CONTROLS
        // =====================================================================
        function toggleSound() {
            if (soundPlaying) {
                audio.pause();
                soundPlaying = false;
            } else {
                audio.play();
                soundPlaying = true;
            }
        }

        function updateVolume() {
            audio.volume = volumeSlider.value;
        }

        // =====================================================================
        // LOCALSTORAGE PERSISTENCE (Scare Container Only)
        // =====================================================================
        function saveScarePosition() {
            localStorage.setItem('scareContainer_left', scareContainer.style.left);
            localStorage.setItem('scareContainer_top', scareContainer.style.top);
            localStorage.setItem('scareContainer_width', scareContainer.style.width);
            localStorage.setItem('scareContainer_height', scareContainer.style.height);
        }

        function loadScarePosition() {
            const left = localStorage.getItem('scareContainer_left');
            const top = localStorage.getItem('scareContainer_top');
            const width = localStorage.getItem('scareContainer_width');
            const height = localStorage.getItem('scareContainer_height');

            if (left && top && width && height) {
                scareContainer.style.left = left;
                scareContainer.style.top = top;
                scareContainer.style.width = width;
                scareContainer.style.height = height;
                console.log('✅ Restored scare container position from localStorage');
            } else {
                // Set defaults
                resetScarePosition();
            }
        }

        // =====================================================================
        // DEBUG MODE
        // =====================================================================
        function toggleDebugMode() {
            if (debugModeCheckbox.checked) {
                console.log('🧪 Debug mode enabled - showing test scare image');
                videoContainer.style.display = 'none';
                scareContainer.style.display = 'block';

                // Automatically show scare border and resize handle for positioning
                scareBorderVisible = true;
                scareContainer.style.border = '2px solid red';
                scareResizeHandle.style.display = 'block';
            } else {
                console.log('📹 Debug mode disabled - showing video');
                scareContainer.style.display = 'none';
                videoContainer.style.display = 'block';

                // Hide scare border and resize handle when exiting debug mode
                scareBorderVisible = false;
                scareContainer.style.border = 'none';
                scareResizeHandle.style.display = 'none';
            }
        }

        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        resetVideoPosition();
        loadScarePosition();

        // =====================================================================
        // SCARE SYSTEM - STATUS POLLING
        // =====================================================================

        let currentState = "VIDEO";
        let currentImageUrl = null;
        const pollingInterval = 500; // ms

        console.log('🎃 Scare system initialized');

        // Start polling status.json
        function checkStatus() {
            // Don't poll if in debug mode
            if (debugModeCheckbox.checked) {
                return;
            }

            // Cache-busting to prevent stale reads
            fetch(`status.json?t=${Date.now()}`)
                .then(response => response.json())
                .then(data => {
                    // Detect if state OR image URL has changed
                    const stateChanged = data.state !== currentState;
                    const imageChanged = data.image_url !== currentImageUrl;

                    if (stateChanged || imageChanged) {
                        if (stateChanged) {
                            console.log(`State change: ${currentState} → ${data.state}`);
                        }
                        if (imageChanged && data.state === "IMAGE") {
                            console.log(`Image change: ${currentImageUrl} → ${data.image_url}`);
                        }

                        switchState(data.state, data.image_url);
                        currentState = data.state;
                        currentImageUrl = data.image_url;
                    }
                })
                .catch(error => {
                    // Silently fail - status.json might not exist yet
                    if (currentState !== "VIDEO") {
                        console.error('Status check failed:', error);
                    }
                });
        }

        function switchState(newState, imageUrl) {
            if (newState === "IMAGE" && imageUrl) {
                console.log(`👻 SCARE! Showing image: ${imageUrl}`);

                // Load generated image with cache-busting
                scareImage.src = imageUrl + `?t=${Date.now()}`;

                // Switch containers: hide video, show scare
                videoContainer.style.display = 'none';
                scareContainer.style.display = 'block';

            } else if (newState === "VIDEO") {
                console.log('📹 Returning to video');

                // Switch containers: hide scare, show video
                scareContainer.style.display = 'none';
                videoContainer.style.display = 'block';
            }
        }

        // Start polling
        setInterval(checkStatus, pollingInterval);
        console.log(`⏱️  Polling status.json every ${pollingInterval}ms`);

        // Initial check
        checkStatus();
    </script>
</body>
</html>
