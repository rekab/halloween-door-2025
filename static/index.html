<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjustable Door Video Projection with Sound</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: white;
            overflow: hidden;
        }
        #videoContainer {
            position: absolute;
            overflow: hidden;
            min-width: 100px;
            min-height: 100px;
        }
        #resizeHandle {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 20px;
            height: 20px;
            background: #666;
            cursor: se-resize;
            display: none;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotate(90deg);
            transform-origin: center;
            transition: opacity 0.5s ease;
        }
        #scareImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotate(90deg);
            transform-origin: center;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
            transition: opacity 0.3s ease;
        }
        #audioControls {
            margin-top: 10px;
        }
        #controlToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .control-toggle-label {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-toggle-label input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <label class="control-toggle-label" id="controlToggle">
        <input type="checkbox" id="showControls" checked> Show Controls
    </label>

    <div id="videoContainer">
        <video autoplay loop muted playsinline>
            <source src="creepyhands2.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <img id="scareImage" alt="Scare Image">
        <div id="resizeHandle"></div>
    </div>
    <div id="controls">
        <button onclick="toggleBorder()">Toggle Border</button>
        <button onclick="resetPosition()">Reset Position</button>
        <div id="audioControls">
            <button onclick="toggleSound()">Toggle Sound</button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()">
        </div>
    </div>

    <audio id="soundTrack" loop>
        <source src="warcry.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <script>
        const container = document.getElementById('videoContainer');
        const resizeHandle = document.getElementById('resizeHandle');
        const audio = document.getElementById('soundTrack');
        const volumeSlider = document.getElementById('volumeSlider');
        const controls = document.getElementById('controls');
        const showControlsCheckbox = document.getElementById('showControls');
        const controlToggle = document.getElementById('controlToggle');
        let isDragging = false;
        let isResizing = false;
        let startX, startY, startWidth, startHeight;
        let borderVisible = false;
        let soundPlaying = false;

        // Set initial volume
        audio.volume = volumeSlider.value;

        // Control visibility toggle
        showControlsCheckbox.addEventListener('change', function() {
            controls.style.opacity = this.checked ? '1' : '0';
            controls.style.pointerEvents = this.checked ? 'auto' : 'none';
        });

        // Move control toggle when controls are hidden
        showControlsCheckbox.addEventListener('change', function() {
            if (this.checked) {
                controlToggle.style.right = '10px';
            } else {
                controlToggle.style.right = '10px';
            }
        });

        container.addEventListener('mousedown', (e) => {
            if (e.target === resizeHandle) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(document.defaultView.getComputedStyle(container).width, 10);
                startHeight = parseInt(document.defaultView.getComputedStyle(container).height, 10);
            } else {
                isDragging = true;
                startX = e.clientX - container.offsetLeft;
                startY = e.clientY - container.offsetTop;
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                container.style.left = (e.clientX - startX) + 'px';
                container.style.top = (e.clientY - startY) + 'px';
            } else if (isResizing) {
                const width = startWidth + (e.clientX - startX);
                const height = startHeight + (e.clientY - startY);
                container.style.width = width + 'px';
                container.style.height = height + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
        });

        function toggleBorder() {
            borderVisible = !borderVisible;
            container.style.border = borderVisible ? '2px solid #666' : 'none';
            resizeHandle.style.display = borderVisible ? 'block' : 'none';
        }

        function resetPosition() {
            container.style.left = '0px';
            container.style.top = '0px';
            container.style.width = '50%';
            container.style.height = '50%';
        }

        function toggleSound() {
            if (soundPlaying) {
                audio.pause();
                soundPlaying = false;
            } else {
                audio.play();
                soundPlaying = true;
            }
        }

        function updateVolume() {
            audio.volume = volumeSlider.value;
        }

        // Initial position and size
        resetPosition();

        // =====================================================================
        // SCARE SYSTEM - STATUS POLLING
        // =====================================================================

        let currentState = "VIDEO";
        const pollingInterval = 500; // ms
        const scareImage = document.getElementById('scareImage');
        const video = document.querySelector('video');

        console.log('üéÉ Scare system initialized');

        // Start polling status.json
        function checkStatus() {
            // Cache-busting to prevent stale reads
            fetch(`status.json?t=${Date.now()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.state !== currentState) {
                        console.log(`State change: ${currentState} ‚Üí ${data.state}`);
                        switchState(data.state, data.image_url);
                        currentState = data.state;
                    }
                })
                .catch(error => {
                    // Silently fail - status.json might not exist yet
                    if (currentState !== "VIDEO") {
                        console.error('Status check failed:', error);
                    }
                });
        }

        function switchState(newState, imageUrl) {
            if (newState === "IMAGE" && imageUrl) {
                console.log(`üëª SCARE! Showing image: ${imageUrl}`);

                // Fade out video
                video.style.opacity = '0';

                setTimeout(() => {
                    // Load and show image with cache-busting
                    scareImage.src = imageUrl + `?t=${Date.now()}`;
                    scareImage.style.display = 'block';

                    // Fade in image
                    setTimeout(() => {
                        scareImage.style.opacity = '1';
                    }, 50);
                }, 500);

            } else if (newState === "VIDEO") {
                console.log('üìπ Returning to video');

                // Fade out image
                scareImage.style.opacity = '0';

                setTimeout(() => {
                    scareImage.style.display = 'none';

                    // Fade in video
                    video.style.opacity = '1';
                }, 500);
            }
        }

        // Start polling
        setInterval(checkStatus, pollingInterval);
        console.log(`‚è±Ô∏è  Polling status.json every ${pollingInterval}ms`);

        // Initial check
        checkStatus();
    </script>
</body>
</html>
